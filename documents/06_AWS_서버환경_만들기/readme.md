# 06. AWS 서버 환경을 만들어보자 - AWS EC2
## 06.0 Intro
- 외부에서 서비스에 접근하도록 하는 방법
    1. 집 pc를 24시간 구동시키기...
    2. 호스팅 서비스 이용
    3. 클라우드 서비스 이용
- 일반적으로 `1`과 `2`가 비용이 저렴하지만, 유동적인 사양 조절이 가능한 클라우드가 유리함
- 클라우드 서비스란?
    - 인터넷(클라우드)을 통해 서버, 스토리지, 데이터 베이스, 네트워크, 소프트웨어, 모니터링 등의 컴퓨팅 서비스를 제공하는 것
    - 단순히 서버 장비를 대여주는게 아닌, 로그관리, 모니터링, 하드웨어 교체, 네트워크 관리 등을 지원해주는 거임
    
- 클라우드의 형태
    1. Infrastructure as a Service (IaaS)
        - 기존 물리 장비를 미들웨어와 함께 묶어둔 추상화 서비스
        - **가상머신, 스토리지, 네트워크, 운영체제** 등의 IT인프라 대여해주는 서비스
        - ex. AWS의 EC2, S3 등
    2. Platform as a Service (PaaS)
        - **IaaS를 한 번 더 추상화**한 서비스, 더 많은 기능이 자동화 되어 있음
        - ex. AWS의 Beanstalk(빈스톡), Heroku(헤로쿠) 등
    3. Software as a Service (SaaS)
        - 소프트웨어 서비스
        - ex. 구글 드라이브, 드랍박스, 와탭 등
    
- 여기서는 AWS가 제공하는 클라우드 서비스를 이용할 거에요
    1. 첫 가입 시 1년가 대부분의 서비스가 무료 (단, 제한이 있음)
    2. 모니터링, 로그관리, 백업, 복구, 클러스터링 등 기본적으로 지원하는 기능이 많아 개발에 집중하기 쉬움
    3. 국내 AWS의 점유율이 매우 높음
    4. 사용자가 많아, 국내 자료와 커뮤니티가 활성화 되어있음
    - 특히 AWS에서 제공하는 IaaS를 사용하여 이것저것 직접 다뤄볼 것임.



## 06.1 AWS 회원 가입
- AWS 가입을 위해선 **Master혹은 Visa 카드**가 필요하다
- [AWS 공식사이트](https://aws.amazon.com/ko/)로 이동한 뒤 무료계정 만들기

## 06.2 EC2 인스턴스 생성하기
- EC2(Elastic Compare Cloud)는 성능, 용량 등을 유동적으로 사용할 수 있는 서버임
- 무료 제공되는 프리티어 플랜에는 다음과 같은 제한이 있음
    1. 사양제한 t2.micro만 가능합니다
        - vCPU 1 Core, 메모리 1GB
        - vCPU = 1/2 CPU
    2. 월 750시간의 제한, 초과하면 비용이 부과됨
        - 24시간 * 31일 = 744시간
        - 1대의 t1.micro만 사용하면 24시간동안 사용 가능함!!
    
1. 리전 변경하기
    - 보통 처음엔 오아이주로 선택되어 있음
    - 서울로 변경해야 국내 센터의 머신을 사용할 수 이따
2. EC2 대시보드로 들어가서 인스턴스 생성하기
    1. EC2검색해서 들어가기
    2. 인스턴스 시작 버튼 누르기
    3. AMI (Amazon Machine Image) 선택하기
        - AMI란? EC2 인스턴스를 생성하는데 필요한 정보를 이미지로 만들어 둔 것!!
        - 여기서는 Amazon Linux2 AMI 선택 (책에는 1이라고 했는데, 이게 지원 종료됨 ㅋ)
    4. 인스턴스 유형 선택하기
        - 프리티어 t2.micro를 선택하자
        - 다른건 비용이 청구됨
        - t2를 포함해서 t3 등을 T시리즈라고 부름 - 저사양 인스턴스는 T시리즈에밖에 없음
        - T시리즈는 '크레딧'이라는 CPU자원을 사용함
    5. VPC, 서브넷 등의 세팅은 기업에 가서 해보셈 ㅇㅇ
    6. 스토리지 선택하기
        - 서버의 용량 정하는거임
        - 기본 값은 8GB, 프리티어 최대값은 30GB이다
        - 30GB로 설정하자
    7. 태그 등록하기
        - 웹 콘솔에 표기될 'Name'태그를 등록해보자
        - EC2 인스턴스를 표현하는 이름을 등록하는거임
        - 키: Name, 값: freelec-springboot2-webservice
    8. 보안 그룹
        - 방화벽을 이야기함
        - *서버로 80포트 외에는 허용하지 않겠습니다*라는 방화벽이 AWS의 보안그룹으로 사용됨
        - 보안그룹을 생성해서 **유의미한 이름**으로 변경함
        - 유형 항목 SSH면서 포트 항목 22인 경우는 AWS EC2에 터미널로 접속할 때를 이야기함, 전체오픈(0.0.0.0/0)하지말고 pem키 관리와 지정된 IP에서만 SSH접속이 가능하도록 구성하자
            - 내 IP(자동으로 현재 접속한 IP가 자동 지정됨)를 추가하고, 나중에 다른 IP도 쓸려면 추가해라
        - 현재 프로젝트의 기본 포트인 8080을 추가하고 '검토 및 시작'을 누르자
            - 경고는 무시하고 '시작하기' (8080은 열어놔도 안위험함)
    9. pem키 선택하기
        - 22포트를 막아놨으니 pem키를 선택해야댐
        - 인스턴스는 지정된 pem키(비밀키)와 매칭되는 공개키를 가지고 있음
        - pem키는 비밀키 이므로 절-대 유츌되서는 안된다
        - 이후 EC2접속시 꼭 필요하니 **잘 관리할 수 있는 디렉토리**로 저장하자
            - **절대 잃어버리면 안돼!!**
        - 새 키 페어 생성 > 키 페어 다운로드
        - 인스턴스 시작!
    
3. EIP 할당
    - 인스턴스의 IP는 생성될 때, 다시 시작할 때 매번 변경됨
    - 따라서, 고정 IP를 가지게 해야 웹서비스를 이용할 수 있음
    - **EIP = Elastic IP**는 AWS의 고정 IP를 부르는 이름
    1. EC2인스턴스 페이지 왼쪽 카테고리에서 '탄력적 IP'를 선택
    2. '새 주소 할당' 클릭, '할당' 클릭
    3. 탄력적 IP를 '작업' -> '주소연결' 을 통해 EC2인스턴스에 연결 (54.180.205.121)
    - 주의사항
        - 연결되지 않은 탄력적 IP는 비용이 발생함!!!

## 06.3 EC2 서버에 접속하기
### Mac & Linux
- 아무설정 없이 접근하려면 매번 `ssh -i pem 키위치 EIP`를 입력해야함
- 설정을 좀 해주자
    1. pem키 파일을 `~/.ssh/`로 복사
        - `~/.ssh/`로 옮겨진 pem은 ssh실행시 자동으로 읽혀짐
    2. 복사된 pem키의 권한 변경
        - 600으로 권한 설정하기
    3. `~/.ssh/`디렉토리에 config파일 생성
        - `vim ~/.ssh/config`
        - 본인이 원하는 Host로 등록하기 - HostName에 EIP를 사용하면 댐댐이
        ~~~
        Host _서비스명_
            HostName _EIP_
            User ec2-user
            IdentityFile ~/.ssh/_pem키위치_
        ~~~
    4. config파일 권한을 700으로 설정하기
- 이제 `ssh _서비스명_`으로 접속이 가능해졌다~!! 

### Window
- putty
- xshell: [티스토리 블로그](https://mandlife.tistory.com/entry/XShell-AWS-EC2-XShell%EB%A1%9C-1%EB%B6%84-%EC%97%B0%EA%B2%B0%ED%95%98%EB%8A%94%EB%B2%95)

## 06.4 아마존 리눅스 서버 생성 시 꼭 해야 할 설정
- 자바 기반의 웹 애플리케이션 (톰캣, 스프링부트)가 작동해야 하는 서버에서 필요한 것들
1. Java 8 설치
2. 타임존 변경 - 서버 기본 시간대가 미국임
3. 호스트 네임 변경 - IP명으론 어떤 서버가 어떤 역할을 하는지 하는지 알 수 없음
### Java 8 설치
1. `sudo yum install -y java-1.8.0-openjdk-devel.x86_64`
2. `sudo /usr/sbin/alternatives --config java`
    - 1.8.0 선택
3. `sudo yum remove java-1.7.0-openjdk`

### 타임존 변경
- 세계표준시간(UTC)를 한국시간(KST)로 변경
- `sudo rm /etc/localtime`
- `sudo ln -s /usr/share/zoneinfo/Asia/Seoul /etc/localtime`
- `date`라고 쳤을 때 KST가 나오면 성공

### Hostname 변경
- **너, IP만 보고 무슨 서비스의 서번지 알 수 있니?**
1. 변경하기
    1. HOSTNAME편집 파일 열기
        - `sudo vim /etc/sysconfig/network`
    2. Hostname 변경하기
    ~~~
    HOSTNAME=_원하는서비스명_
    ~~~
    - 또는
    - `sudo hostnamectl set-hostname _원하는서비스명_`
2. `reboot`
- 한 가지더, `/etc/hosts`에 변경한 hostname을 등록하지 않으면 큰일남!!! [관련자료](https://woowabros.github.io/experience/2017/01/20/billing-event.html)
- `sudo vim /etc/hosts`
~~~
127.0.0.1 등록한HOSTNAME
~~~
- `curl 등록한HOSTNAME`으로 확인해보자
    - [ Failed to connect to ] 에러가 발생한다
    - 아직 80포트로 실행된 서비스가 없어서 그런거니, 잘된거다 (만약 등록이 안됐으면 [ Could not resolve host: ]에러가 남)
    